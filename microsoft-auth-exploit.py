#!/usr/bin/env python3

# MaxRockatasky - 27th June 2022

import requests,json

#these are microsoft authentication tokens, something other than the minecraft access token
#user should fill in the following data which can be found in multimc/accounts.json:
refresh_token=""
token=""

#DO NOT EDIT CODE BELOW THIS LINE

task=input("Enter the corresponding number:\n1 - Validate Microsoft Token\n2 - Refresh Microsoft Token WIP\n3 - Obtain Minecraft Access Token\n")
if task=="1":
    #xbox live authentication request
    payload={
        "Properties": {
            "AuthMethod": "RPS",
            "SiteName": "user.auth.xboxlive.com",
            "RpsTicket": "d="+token
        },
        "RelyingParty": "http://auth.xboxlive.com",
        "TokenType": "JWT"
    }

    r=requests.post("https://user.auth.xboxlive.com/user/authenticate",json=payload,headers={"Content-Type":"application/json","Accept":"application/json"})
    print(r.status_code)
    print(r.content)

    if r.status_code == 200:
        print("------------------\nThe token is valid\n------------------")
    else:
        print("--------------------\nThe token is invalid\n--------------------")
if task=="2":
    #refresh token
    print()
if task=="3":
    #xbox live authentication request
    payload={
        "Properties": {
            "AuthMethod": "RPS",
            "SiteName": "user.auth.xboxlive.com",
            "RpsTicket": "d="+token
        },
        "RelyingParty": "http://auth.xboxlive.com",
        "TokenType": "JWT"
    }

    r=requests.post("https://user.auth.xboxlive.com/user/authenticate",json=payload,headers={"Content-Type":"application/json","Accept":"application/json"})
    print(r.status_code)
    print(r.content)

    if r.status_code == 200:
        print("------------------\nThe token is valid\n------------------")
    else:
        print("--------------------\nThe token is invalid\n--------------------")
        quit()
    
    xbl_token=json.loads(r.content)["Token"]
    userhash=json.loads(r.content)["DisplayClaims"]["xui"][0]["uhs"]
    print(xbl_token)
    print(userhash)

    #xsts authentication request
    payload={
        "Properties": {
        "SandboxId": "RETAIL",
        "UserTokens": [
            xbl_token
        ]
        },
    "RelyingParty": "rp://api.minecraftservices.com/",
    "TokenType": "JWT"
    }

    r=requests.post("https://xsts.auth.xboxlive.com/xsts/authorize",json=payload,headers={"Content-Type":"application/json","Accept":"application/json"})
    print(r.status_code)
    print(r.content)

    if r.status_code == 200:
        print("------------------\nThe token is valid\n------------------")
    else:
        print("--------------------\nThe token is invalid\n--------------------")
        quit()

    xsts_token=json.loads(r.content)["Token"]

    #minecraft authentication request
    payload={
        "identityToken": "XBL3.0 x="+userhash+";"+xsts_token
    }
    r=requests.post("https://api.minecraftservices.com/authentication/login_with_xbox",json=payload,headers={"Content-Type":"application/json","Accept":"application/json"})
    print(r.status_code)
    print(r.content)

    if r.status_code == 200:
        print("------------------\nThe token is valid\n------------------")
    else:
        print("--------------------\nThe token is invalid\n--------------------")
        quit()

    print("MINECRAFT ACCESS TOKEN:")
    print(json.loads(r.content)["access_token"])
    